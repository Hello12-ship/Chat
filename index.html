<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat App Final</title>
<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#0b141a;color:white;transition:0.3s;}
.screen{display:none;height:100vh;justify-content:center;align-items:center;flex-direction:column;padding:20px;}
h2,h3{margin-bottom:20px;}
button,input{padding:12px 16px;font-size:16px;border:none;border-radius:12px;margin:5px;cursor:pointer;}
button{background:#1f2c38;color:white;transition:0.2s;}
button:hover{background:#005c4b;}
input{flex:1;border-radius:12px;outline:none;padding:10px;}
.card{background:#1f2c38;padding:20px;border-radius:16px;margin:10px;text-align:center;width:240px;box-shadow:0 6px 16px rgba(0,0,0,0.3);}
#chat{display:flex;flex-direction:column;height:100vh;max-width:600px;margin:auto;background:#0f1b26;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
#messages{flex:1;overflow-y:auto;padding:10px;scroll-behavior:smooth;}
.msg{display:flex;margin:6px 0;max-width:80%;}
.msg .bubble{padding:10px 14px;border-radius:20px;position:relative;display:inline-block;word-break:break-word;}
.msg.me{justify-content:flex-end;}
.msg.me .bubble{background:#005c4b;border-bottom-right-radius:4px;color:white;}
.msg.other{justify-content:flex-start;}
.msg.other .bubble{background:#202c33;border-bottom-left-radius:4px;color:white;}
.msg img{width:36px;height:36px;border-radius:50%;margin:0 8px;cursor:pointer;}
#inputBar{display:flex;padding:10px;background:#0b141a;align-items:center;}
#inputBar input{flex:1;margin-right:6px;}
#typing{font-size:13px;opacity:0.7;margin-left:10px;margin-bottom:4px;}
#users{font-size:13px;opacity:0.7;margin:5px 10px;}
#profileModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;}
#profileContent{background:#1f2c38;padding:20px;border-radius:16px;text-align:center;width:280px;}
#profileContent input{margin:8px 0;width:100%;}
#userInfo{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1f2c38;padding:16px;border-radius:16px;display:none;text-align:center;}
#userInfo img{width:80px;height:80px;border-radius:50%;margin-bottom:8px;}
#emojiBtn{background:#1f2c38;color:white;border-radius:50%;font-size:20px;padding:6px 10px;margin-right:6px;}
</style>
</head>
<body>

<!-- HOME -->
<div id="home" class="screen">
  <h2>üåê Chat App</h2>
  <div class="card"><button onclick="joinRoom('public')">Public Chat üåç</button></div>
  <div class="card"><button onclick="showGroups()">Groups üë•</button></div>
  <div class="card"><button onclick="privateMenu()">Private üîê</button></div>
  <div class="card"><button onclick="openProfile()">‚öôÔ∏è Profile</button></div>
</div>

<!-- GROUPS -->
<div id="groups" class="screen">
  <h3>Choose a Group</h3>
  <div class="card">
    <button onclick="joinRoom('group-gaming')">üéÆ Gaming</button>
    <button onclick="joinRoom('group-study')">üìö Study</button>
    <button onclick="joinRoom('group-general')">üí¨ General</button>
  </div>
  <button onclick="back()">‚¨Ö Back</button>
</div>

<!-- PRIVATE MENU -->
<div id="privateMenu" class="screen">
  <h3>Private Room</h3>
  <div class="card">
    <button onclick="privateJoinExisting()">Join Existing Room</button>
    <button onclick="privateCreateRoom()">Create New Room</button>
  </div>
  <button onclick="back()">‚¨Ö Back</button>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
  <div id="users">Online: </div>
  <div id="messages"></div>
  <div id="typing"></div>
  <div id="inputBar">
    <button id="emojiBtn" onclick="insertEmoji('üòä')">üòä</button>
    <input id="text" placeholder="Type a message..." oninput="typing(true)">
    <button onclick="send()">Send</button>
    <button onclick="leave()">Leave</button>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal">
  <div id="profileContent">
    <h3>Profile Settings</h3>
    <input type="text" id="profileName" placeholder="Username">
    <input type="text" id="profileAbout" placeholder="About">
    <input type="file" id="profilePicFile" accept="image/*">
    <button onclick="saveProfile()">Save</button>
    <button onclick="closeProfile()">Cancel</button>
  </div>
</div>

<!-- USER INFO POPUP -->
<div id="userInfo">
  <img id="infoPic">
  <h4 id="infoName"></h4>
  <p id="infoAbout"></p>
  <button onclick="closeUserInfo()">Close</button>
</div>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<script>
const ably = new Ably.Realtime("KFH2jQ.6gDraw:-edY27j1_UfE8-TrnsJDxCn27Mv4hrB01X1MCgshXHg");
let channel, room="", users={}, myId = Math.random().toString(36).slice(2,6);

let profile = JSON.parse(localStorage.getItem("chat_profile")) || {};
if(!profile.name){
  profile.name = prompt("Enter your username") || "Guest";
  profile.about = ""; profile.pic="";
  localStorage.setItem("chat_profile", JSON.stringify(profile));
}

function show(id){ document.querySelectorAll(".screen").forEach(s=>s.style.display="none"); document.getElementById(id).style.display="flex"; }
show("home");
function showGroups(){ show("groups"); }
function privateMenu(){ show("privateMenu"); }
function back(){ show("home"); }

// PROFILE
function openProfile(){
  document.getElementById("profileName").value = profile.name;
  document.getElementById("profileAbout").value = profile.about;
  document.getElementById("profileModal").style.display="flex";
}
function closeProfile(){ document.getElementById("profileModal").style.display="none"; }
function saveProfile(){
  profile.name = document.getElementById("profileName").value || profile.name;
  profile.about = document.getElementById("profileAbout").value || "";
  const fileInput = document.getElementById("profilePicFile");
  if(fileInput.files && fileInput.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      // ‚úÖ Compress image to max width 150
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const scale = Math.min(150/img.width,150/img.height,1);
        canvas.width = img.width*scale;
        canvas.height = img.height*scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        profile.pic = canvas.toDataURL("image/jpeg",0.7);
        localStorage.setItem("chat_profile", JSON.stringify(profile));
      }
      img.src = e.target.result;
    }
    reader.readAsDataURL(fileInput.files[0]);
  }
  localStorage.setItem("chat_profile", JSON.stringify(profile));
  closeProfile();
}

// PRIVATE ROOMS
function privateJoinExisting(){ const code=prompt("Enter room code:"); if(code) joinRoom("private-"+code);}
function privateCreateRoom(){ const code=prompt("Create new room code:"); if(code) joinRoom("private-"+code);}

// JOIN ROOM
function joinRoom(r){
  room = r;
  ably.connection.once('connected',()=>{
    channel = ably.channels.get(room);
    users={};
    show("chat");

    channel.subscribe(msg=>{
      if(msg.name==="join") users[msg.data.id] = msg.data;
      if(msg.name==="leave") delete users[msg.data.id];
      if(msg.name==="msg") addMsg(msg);
      if(msg.name==="typing") showTyping(msg);
      updateUsers();
    });

    // ‚úÖ Publish join
    channel.publish("join",{id:myId,...profile},err=>{ if(err) console.error(err); });
  });
}

// SEND MESSAGE
function send(){
  const t = document.getElementById("text").value.trim();
  if(!t || !channel) return;
  channel.publish("msg",{id:myId,...profile,text:t},err=>{ if(err) console.error("Publish failed:",err); });
  document.getElementById("text").value="";
  typing(false);
}

// ADD MESSAGE
function addMsg(msg){
  const d = document.createElement("div");
  const isMe = msg.data.id === myId;
  d.className = "msg "+(isMe?"me":"other");

  const name = msg.data.name || "Guest";
  const text = msg.data.text || "";
  const pic = msg.data.pic || "https://via.placeholder.com/36";

  const img = document.createElement("img");
  img.src = pic;
  img.onclick = ()=>showUserInfo(msg.data);

  const bubble = document.createElement("div");
  bubble.className="bubble";
  bubble.innerText = (name.length>15?name.slice(0,15)+"‚Ä¶":name) + (text?": "+text:"");

  if(isMe){ d.appendChild(bubble); d.appendChild(img); }
  else{ d.appendChild(img); d.appendChild(bubble); }

  document.getElementById("messages").appendChild(d);
  d.scrollIntoView({behavior:"smooth"});
}

// TYPING
function typing(state){ if(channel) channel.publish("typing",{id:myId,name:profile.name,state}); }
function showTyping(msg){ document.getElementById("typing").innerText = msg.data.state? msg.data.name+" typing..." : ""; }

// UPDATE USERS
function updateUsers(){ const names=Object.values(users).map(u=>u.name); document.getElementById("users").innerText="Online: "+names.join(", "); }
function leave(){ if(channel){ channel.publish("leave",{id:myId}); channel.unsubscribe(); } show("home"); }

// USER INFO
function showUserInfo(u){ document.getElementById("infoPic").src=u.pic||"https://via.placeholder.com/80"; document.getElementById("infoName").innerText=u.name; document.getElementById("infoAbout").innerText=u.about||""; document.getElementById("userInfo").style.display="block"; }
function closeUserInfo(){ document.getElementById("userInfo").style.display="none"; }

// EMOJI
function insertEmoji(e){ document.getElementById("text").value+=e; }
</script>
</body>
</html>
